@using ApexCharts
@using HealthMonitor.Client.Model

<div style="height: 100%;">
    <ApexChart TItem="TrendDataPoint"
               Title="Health Predictions with Confidence Intervals"
               Height="@Height"
               Options="@_chartOptions">

        @foreach (var serviceGroup in Data.GroupBy(d => d.Label))
        {
            <ApexPointSeries TItem="TrendDataPoint"
                           Items="@serviceGroup.Select(MapToTrendPoint).ToList()"
                           Name="@serviceGroup.Key"
                           SeriesType="SeriesType.Area"
                           XValue="@(e => e.Time.ToString("HH:mm"))"
                           YValue="@(e => (decimal)e.HealthScore)" />
        }
    </ApexChart>
</div>

@code {
    [Parameter] public List<ChartData> Data { get; set; } = new();
    [Parameter] public int Height { get; set; } = 350;
    
    private readonly ApexChartOptions<TrendDataPoint> _chartOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = true },
            Zoom = new Zoom { Enabled = true }
        },
        Stroke = new Stroke
        {
            Curve = Curve.Smooth,
            Width = 3,
            DashArray = new List<int> { 0, 5 }
        },
        Fill = new Fill
        {
            Type = new List<FillType> { FillType.Solid, FillType.Pattern }
        },
        Xaxis = new XAxis
        {
            Type = XAxisType.Category,
            Title = new AxisTitle { Text = "Time" }
        },
        Yaxis =
        [
            new YAxis
            {
                Title = new AxisTitle { Text = "Predicted Health Score %" },
                Min = 0,
                Max = 100,
                DecimalsInFloat = 2
            }
        ],
        Legend = new Legend { Position = LegendPosition.Top },
        Annotations = new Annotations
        {
            Yaxis =
            [
                new AnnotationsYAxis
                {
                    Y = 95,
                    BorderColor = "#00E396",
                    Label = new Label
                    {
                        Text = "SLA Threshold",
                        Style = new Style { Color = "#fff", Background = "#00E396" }
                    }
                }
            ]
        }
    };

    private TrendDataPoint MapToTrendPoint(ChartData data) =>
        new()
        {
            Time = data.Time,
            HealthScore = data.Value,
            ServiceId = data.Label
        };

    public class TrendDataPoint
    {
        public DateTime Time { get; set; }
        public double HealthScore { get; set; }
        public string ServiceId { get; set; } = "";
    }
}